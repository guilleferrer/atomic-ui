/*
 * atomic.ui
 * Version: 0.0.1 - 2014-05-06
 * License: EULA
 * Author: Guillermo Ferrer <guilleferrer@gmail.com>
 */
angular.module("ui.atomic",["ui.atomic.alerts","ui.atomic.back","ui.atomic.compile","ui.atomic.confirm","ui.atomic.fbinvite","ui.atomic.tools","ui.atomic.filter","ui.atomic.viewport","ui.atomic.full-screen","ui.atomic.infinite-scroll","ui.atomic.pager","ui.atomic.list","ui.atomic.mailto","ui.atomic.nl2br","ui.atomic.search","ui.atomic.testabit","ui.atomic.truncate","ui.atomic.urlencode","ui.atomic.user-advice","ui.atomic.whatsapp"]),angular.module("ui.atomic.alerts",["ui.bootstrap.alert"]).run(["$rootScope","$timeout",function(a,b){a.alerts=[],a.closeAlert=function(b){a.alerts.splice(b,1)};var c=function(c){a.alerts.push(c),b(function(){a.alerts.pop()},3500)};a.$on("submit.error",function(){c({type:"danger",msg:"alerts.form.validationMessage",keep:!1})}),a.$on("alert.show",function(a,b){c(b)}),a.$on("$stateChangeSuccess",function(){for(var b=a.alerts.length-1;b>=0;b--)a.alerts[b].keep||a.closeAlert(b)})}]),angular.module("ui.atomic.back",[]).directive("back",["$window",function(a){return function(b,c){c.on("click",function(){a.history.back()})}}]),angular.module("ui.atomic.compile",[],["$compileProvider",function(a){a.directive("compile",["$compile",function(a){return function(b,c,d){b.$watch(function(a){return a.$eval(d.compile)},function(d){c.html(d),a(c.contents())(b)})}}])}]),angular.module("ui.atomic.confirm",["ui.bootstrap"]).directive("confirmUrl",["$http","$window","$modal",function(a,b,c){return{scope:{title:"@confirmTitle",message:"@confirmMessage",buttonYes:"@confirmYes",buttonNo:"@confirmNo"},link:function(d,e,f){var g=f.confirmUrl,h=f.confirmMethod||"delete",i=f.actionBtnClass||"btn-ml-danger",j="true"==f.followUrl;e.bind("click",function(e){e.preventDefault(),d.buttons=[{label:d.buttonYes,result:1,cssClass:i},{label:d.buttonNo,result:0,cssClass:"btn-ml-default"}];var f=c.open({scope:d,templateUrl:"template/confirm/confirm.html"});return d.close=function(a){f.close(a)},f.result.then(function(c){1===c&&(j===!0?b.location=g:a[h](g).success(function(a){d.$emit("apiEvent.ACTION_SUCCESS",a)}))}),!1})}}}]),angular.module("ui.atomic.fbinvite",[]).factory("Facebook",function(){var a=function(a,b){FB.ui({method:"apprequests",filters:["app_non_users"],title:a.title,message:a.message},function(a){a&&b&&b(a)})};return{fb:function(){return FB},requestNonAppFriends:function(b,c){a(b,c)}}}).directive("fbinvite",["$http, Facebook",function(a,b){return{restrict:"A",link:function(a,c,d){var e=b;if(angular.isUndefined(d.fbinviteMessage))throw"fbinvite-message parameter is required";var f={title:d.fbinviteTitle,message:d.fbinviteMessage};c.on("click",function(){e.requestNonAppFriends(f)})}}}]),angular.module("ui.atomic.tools",[]).factory("urlTools",function(){function a(b,c){var d=[];for(var e in b){var f=c?c+"["+e+"]":e,g=b[e];d.push("object"==typeof g?a(g,f):encodeURIComponent(f)+"="+encodeURIComponent(g))}return d.join("&")}function b(a){try{return decodeURIComponent(a)}catch(b){}}function c(a){var c,d,e={};return angular.forEach((a||"").split("&"),function(a){if(a&&(c=a.split("="),d=b(c[0]),angular.isDefined(d))){var f=angular.isDefined(c[1])?b(c[1]):!0;e[d]?isArray(e[d])?e[d].push(f):e[d]=[e[d],f]:e[d]=f}}),e}return{toKeyValue:a,parseKeyValue:c}}),angular.module("ui.atomic.viewport",[]).factory("viewport",function(){function a(){var a=angular.element('meta[name="viewport"]').attr("content");return b(a)}function b(a){var b={},c=a.replace(/ /g,"").split(",");return angular.forEach(c,function(a){var b=a.split("=");this[b[0]]=b[1]},b),b}function c(a){var b=[];return angular.forEach(a,function(a,c){b.push(c+"="+a)}),b.join(",")}function d(a,b){e[a]=b;var d=c(e);angular.element('meta[name="viewport"]').attr("content",d)}var e=a();return{get:a,set:d}}),angular.module("ui.atomic.filter",["ui.atomic.tools"]).factory("filterHelper",["urlTools","$stateParams",function(a,b){function c(){return a.parseKeyValue(b.q)}function d(b){var c={};return Object.keys(b).length>0&&(c.q=a.toKeyValue(b,null)),c}return{searchToQuery:c,formToSearch:d}}]).directive("mlFilter",["$state","$stateParams","$location","filterHelper",function(a,b,c,d){return{link:function(e,f,g){var h=g.mlFilter,i=g.name;e.filter={show:!1,active:!1},e[i]={},e[h]=d.searchToQuery(),e[i]=e[h],Object.keys(e[i]).length>0&&(e.filter.active=!0),e.applyFilter=function(){if(e[i].$dirty!==!1){var a=d.formToSearch(e[i]);c.search(a),e.filter.show=!1,e.filter.active=!0,e.$emit("filterEvent.FILTER_CHANGE",a)}},e.resetFilter=function(){b.q=null,a.go(a.current,b,{reload:!1}),e[i]={},e[h]="",e.filter.show=!1,e.filter.active=!1}}}}]),angular.module("ui.atomic.full-screen",["ui.bootstrap","angular-carousel","ui.atomic.viewport"]).directive("fullScreen",["$modal","viewport",function(a,b){return{scope:{images:"=fullScreen"},link:function(c,d){var e;d.on("click",function(){e=a.open({windowClass:"full-modal full-screen",templateUrl:"template/full-screen/full-screen.html",scope:c}),e.opened.then(function(){b.set("maximum-scale","2")}),e.result.then(function(){b.set("maximum-scale","1")})}),c.cancel=function(){e.close()}}}}]),angular.module("ui.atomic.infinite-scroll",[]).directive("infiniteScroll",["$rootScope","$window","$timeout",function(a,b,c){return{link:function(d,e,f){var g,h,i,j;return b=angular.element(b),i=0,null!=f.infiniteScrollDistance&&d.$watch(f.infiniteScrollDistance,function(a){return i=parseFloat(a)}),j=!0,g=!1,null!=f.infiniteScrollDisabled&&d.$watch(f.infiniteScrollDisabled,function(a){return j=!a,j&&g?(g=!1,h()):void 0}),h=function(){var c,h,k,l;return l=b.height(),c=e.offset().top+e.height(),h=c-l,k=20*i>=h,k&&j?a.$$phase?d.$eval(f.infiniteScroll):d.$apply(f.infiniteScroll):k?g=!0:void 0},e.parents(".scroller").on("scroll",h),d.$on("$destroy",function(){return e.parents(".scroller").off("scroll",h)}),c(function(){return f.infiniteScrollImmediateCheck?d.$eval(f.infiniteScrollImmediateCheck)?h():void 0:h()},0)}}}]),angular.module("ui.atomic.pager",[]).provider("pagerCache",function(){this.$get=["$cacheFactory",function(a){return a("pager")}]}).provider("Pager",function(){var a=1;this.setInitialPage=function(b){a=b},this.$get=["$http","$rootScope","pagerCache",function(b,c,d){function e(b,c,d){this.id=(new Date).getTime(),this.search=c||{},this.middleware=d||function(a){return a},this.url=b,this.page=a,this.finished=!1,this.busy=!1,this.showNoResults=!1,this.results=[],this.nbResults=0,this.nbUnread=0}function f(a,b){var c=[];for(var d in a){var e=b?b+"["+d+"]":d,g=a[d];c.push("object"==typeof g?f(g,e):encodeURIComponent(e)+"="+encodeURIComponent(g))}return c.join("&")}return e.prototype.nextPage=function(a,e){var g={};if(e!==!1&&(g.cache=d),!this.busy&&!this.finished){this.busy=!0;var h=this.url;this.search=angular.extend(this.search,{page:this.page});var i=f(this.search);h+=i?"?"+i:"";var j=this;b.get(h,g).then(function(b){var d=b.data;return j.busy=!1,j.nbResults=d.nbResults,j.nbUnread+=d.nbUnread,j.showNoResults=0==d.results.length,angular.forEach(d.results,function(a){j.results.push(j.middleware(a))}),0==d.nbPages&&0==j.results.length&&c.$broadcast("pager.no_results",j.id),angular.isFunction(a)&&a(j),c.$broadcast("pager.page_loaded",j.page,j.results),d.nbPages==j.page||0==d.results.length?(j.finished=!0,void c.$broadcast("pager.last_page")):void(j.page+=1)})}},e}]}),angular.module("ui.atomic.list",["ui.atomic.pager","ui.atomic.infinite-scroll"]).directive("list",["Pager","$rootScope",function(a,b){return{restrict:"E",templateUrl:"template/list/paged-list.html",replace:!0,transclude:!0,link:function(c,d,e){c.listClass=e.listClass||"list-group",c.listCache=e.$attr.listNoCache?!1:!0;var f=c.$eval(e.apiQuery)||{};c.pager=new a(e.apiUrl,f),b.$on("searchEvent.SEARCH_CHANGE",function(b,d,g){angular.extend(f,g),c.pager=new a(e.apiUrl,f),c.pager.nextPage()})}}}]).directive("listItem",function(){return{restrict:"E",replace:!0,templateUrl:function(a,b){return b.itemTplUrl||"template/list/list-item.html"}}}),angular.module("ui.atomic.mailto",[]).directive("mailto",function(){return{restrict:"A",scope:{mailto:"="},link:function(a,b,c){var d=c.mailto,e=c.mailtoSubject,f=c.mailtoContent;b.bind("click",function(){window.location="mailto:"+d+"?subject="+e+"&body="+encodeURIComponent(f)}),a.$watch("mailto",function(a){a&&(d=a)})}}}),angular.module("ui.atomic.nl2br",[]).filter("nl2br",[function(){return function(a,b){if(a){var b=b||!0,c=b?"<br />":"<br>",a=(a+"").replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g,"$1"+c+"$2");return a}return""}}]),angular.module("ui.atomic.search",["ui.atomic.pager"]).directive("searchDispatcher",["$timeout",function(a){return{link:function(b,c,d){function e(a){var c={};c[g]=a,b.$emit("searchEvent.SEARCH_CHANGE",a,c)}var f,g=d.searchField;b.$watch(d.ngModel,function(b,c){b!==c&&(a.cancel(f),f=a(function(){e(b)},1e3))})}}}]).directive("searchPager",["$timeout","$rootScope","Pager",function(a,b,c){return{scope:{searchParams:"@",pager:"=searchPager"},require:"ngModel",link:function(d,e,f){function g(a,b,e){b&&(e.name=b),d.pager=new c(d.pager.url,e),d.pager.nextPage()}var h;d.$watch(f.ngModel,function(c,e){c!==e&&(a.cancel(h),h=a(function(){b.$broadcast("search.change",c,d.$eval(d.searchParams))},1e3))}),d.$on("search.change",g)}}}]).directive("search",["$timeout","$rootScope","$resource",function(a,b,c){return{restrict:"EA",templateUrl:function(a,b){return b.templateUrl||"/tpl/search.html"},scope:{searchParams:"@",searchUrl:"@","class":"@",inputClass:"@",listClass:"@",placeholder:"@",noResultMessage:"@"},replace:!0,transclude:!0,controller:function(b,d){function e(a,d,e){d&&(e.name=d,c(b.searchUrl,e).get(function(a){b.results=a.results,b.showNoresult=0===b.results.length}))}b.results=[],b.search="",b.showNoresult=!1;var f,g=b.$eval(b.searchParams)||{};b.$watch("search",function(c,d){c!==d&&(a.cancel(f),f=a(function(){b.$emit("search.change",c,g)},500)),c||(b.showNoresult=!1,b.results=[])}),d.$on("search.change",e)}}}]).directive("searchItem",function(){return{restrict:"EA",templateUrl:"/tpl/search/item.html",require:"^search",replace:!0}}),angular.module("ui.atomic.testabit",["angulartics","angulartics","ui.bootstrap"]).config(["$analyticsProvider",function(a){var b="/";a.registerPageTrack(function(a){b=a,window.ga&&ga("send","pageview",a)}),a.registerEventTrack(function(a,c){window.ga&&window.ga("send","event",c.category,a,c.label,{page:b})})}]).provider("testabit",function(){var a=[],b=["silent","modal"],c=!1;this.setDebugMode=function(a){c=a},this.setCategories=function(b){if(!angular.isArray(b))throw"Categories for testabit should be an array";a=b},this.$get=["$log","$analytics",function(d,e){function f(a,b,f,g){var h={category:a,label:f};""!==g&&(h.value=g),c&&d.log("Testabit.eventTrack : ","action: ",b,"/ category: ",h.category,"/ label: ",h.label),e.eventTrack(b,h)}var g={};return angular.extend(g,{eventTrack:f,allowedCategories:a,allowedTypes:b,debugMode:c}),g}]}).directive("testabit",["testabit","$log","$modal",function(a,b,c){function d(a){return"testabit error : "+a}function e(c){var e=!1;return-1===a.allowedTypes.indexOf(c.testabit)&&(b.log(d("Invalid testabit parameter '"+c.testabitCategory+"' . The testabit type should be one of these : "),a.allowedTypes),e=!0),-1===a.allowedCategories.indexOf(c.testabitCategory)&&(b.log(d("Invalid category '"+c.testabitCategory+"' . The category should be one of these : "),a.allowedCategories),e=!0),c.testabitAction||(b.log(d("Invalid action '"+c.testabitAction+"'")),e=!0),c.testabitLabel||(b.log(d("Invalid label '"+c.testabitLabel+"'")),e=!0),e?!1:{category:c.testabitCategory,action:c.testabitAction,label:c.testabitLabel,value:c.testabitValue}}return function(b,d,f){a.debugMode&&d.css("border","2px dashed white");var g=function(){var b=e(f);if(b===!1)return void(a.debugMode&&d.css("border","2px dashed red"));if("modal"===f.testabit){var g=[{label:"testabit.button.no",result:0,cssClass:"btn-ml-default"},{label:"testabit.button.yes",result:1,cssClass:"btn-ml-primary"}],h=c.open({templateUrl:"template/testabit/modal.html",controller:"MessageBoxController",resolve:{model:function(){return{buttons:g}}}});h.result.then(function(c){var d=parseInt(c)>0?"positive_vote":"negative_vote";a.eventTrack(b.category,b.action+"."+d,b.label,c)})}else a.eventTrack(b.category,b.action,b.label,b.value)};d.bind("click",function(){b.$apply(g)})}}]).controller("MessageBoxController",["$scope","$modalInstance","model",function(a,b,c){a.close=function(a){b.close(a)},a.buttons=c.buttons}]),angular.module("ui.atomic.truncate",[]).filter("truncate",function(){return function(a,b,c){return a?(isNaN(b)&&(b=100),void 0===c&&(c="..."),a.length<=b||a.length-c.length<=b?a:String(a).substring(0,b-c.length)+c):""}}),angular.module("ui.atomic.urlencode",[]).filter("urlencode",[function(){return function(a){return encodeURIComponent(a)}}]),angular.module("ui.atomic.user-advice",[]).directive("userAdvice",["$http, $document, $rootScope",function(a,b,c){return{link:function(d,e,f){var g=f.userAdvice,h="/api/advices/"+g+"/disable",i=function(){d.$apply(function(){a.get(h),b.find(".advice-"+g).remove(),c.$broadcast("advice.disable",g)})};e.bind("click",i)}}}]),angular.module("ui.atomic.whatsapp",["adaptive.detection"]).directive("whatsapp",["$window","$detection","$rootScope",function(a,b){return{restrict:"A",link:function(c,d,e){b.isiOS()?d.bind("click",function(){a.location="whatsapp://send?text="+encodeURIComponent(e.whatsapp)}):d.hide()}}}]);